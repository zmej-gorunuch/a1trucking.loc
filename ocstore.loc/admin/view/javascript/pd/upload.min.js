/*
 * Product Downloads PRO file upload extension
 *
 */
$.widget("blueimp.fileupload",$.blueimp.fileupload,{options:{maxNumberOfFiles:void 0,autoUpload:!1,model:void 0,dataType:"json",getNumberOfFiles:function(){var e=0;return this.model.files().forEach(function(t){e+=1*!t.processing()}),e},getFilesFromResponse:function(e){return e.result&&$.isArray(e.result.files)?e.result.files:e.files&&$.isArray(e.files)?e.files:[]},add:function(e,t){if(e.isDefaultPrevented())return!1;var r=this,i=$(this),o=i.data("blueimp-fileupload")||i.data("fileupload"),n=o.options;return"number"==typeof n.maxNumberOfFiles&&n.maxNumberOfFiles<=n.getNumberOfFiles()?!1:(t.context=o._addUpload(t.files,t),t.context.forEach(function(e){e.processing(!0),e._cancelHandler=$.proxy(o._cancelHandler,o),e._startHandler=$.proxy(o._startHandler,o),e._deleteHandler=$.proxy(o._deleteHandler,o)}),void t.process(function(){return i.fileupload("process",t)}).always(function(){t.context.forEach(function(e){e.processing(!1),e.deleting(!1),e.canceling(!1)}),o._controlFileInputButton.call(r)}).done(function(){o._trigger("added",e,t)!==!1&&(n.autoUpload||t.autoUpload)&&t.autoUpload!==!1&&t.submit()}).fail(function(){t.files.error&&t.context.forEach(function(e,r){var i=t.files[r].error;i&&(e.filename.hasError(!0),e.filename.errorMsg(i))})}))},send:function(e,t){if(e.isDefaultPrevented())return!1;var r=$(this).data("blueimp-fileupload")||$(this).data("fileupload");return t.context&&t.dataType&&"iframe"===t.dataType.substr(0,6)&&r.options.model.progress(100),r._trigger("sent",e,t)},done:function(e,t){if(e.isDefaultPrevented())return!1;var r=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),i=t.getFilesFromResponse||r.options.getFilesFromResponse,o=i(t);t.context&&(t.context.forEach(function(e,i){var n=o[i]||{error:"Empty file upload result"};e.uploading(!1),e.uploadable(!1),n.name&&e.filename(n.name),n.mask&&e.mask(n.mask),n.deleteUrl?(e.delete_url(n.deleteUrl),e.uploaded(!0)):e.uploaded(!1),n.type&&e.type(n.type),n.size&&e.size(n.size),n.error?(e.filename.hasError(!0),e.filename.errorMsg(n.error)):(e.filename.hasError(!1),e.filename.errorMsg("")),e.data||(e._cancelHandler=$.proxy(r._cancelHandler,r),e._startHandler=$.proxy(r._startHandler,r),e._deleteHandler=$.proxy(r._deleteHandler,r),e.data=t)}),r._controlFileInputButton.call(this),r._trigger("completed",e,t),r._trigger("finished",e,t))},fail:function(e,t){if(e.isDefaultPrevented())return!1;var r=$(this).data("blueimp-fileupload")||$(this).data("fileupload");t.context?t.context.forEach(function(i,o){if("abort"!==t.errorThrown){var n=t.files[o];n.error=n.error||t.errorThrown||!0,i.uploaded(!1),i.uploading(!1),i.filename.hasError(!0),i.filename.errorMsg(n.error),r._trigger("failed",e,t),r._trigger("finished",e,t)}else i.delete_url()?r._trigger("destroy",e,{context:i,type:"DELETE",url:i.delete_url()}):(r.options.model.removeFile(i),r._controlFileInputButton.call(this)),r._trigger("failed",e,t),r._trigger("finished",e,t)},this):"abort"!==t.errorThrown?(r._controlFileInputButton.call(this),r._trigger("failed",e,t),r._trigger("finished",e,t)):(r._controlFileInputButton.call(this),r._trigger("failed",e,t),r._trigger("finished",e,t))},progress:function(e,t){if(e.isDefaultPrevented())return!1;var r=Math.floor(t.loaded/t.total*100);t.context&&t.context.forEach(function(e){e.progress(r)})},chunkalways:function(e,t){return e.isDefaultPrevented()?!1:void t.context.forEach(function(e,r){var i=t.result&&t.result.files[r];i&&i.deleteUrl&&e.delete_url(i.deleteUrl)})},progressall:function(e,t){if(e.isDefaultPrevented())return!1;var r=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),i=Math.floor(t.loaded/t.total*100);r.options.model.extended_progress(r._renderExtendedProgress(t)),r.options.model.progress(i)},start:function(e){if(e.isDefaultPrevented())return!1;var t=$(this).data("blueimp-fileupload")||$(this).data("fileupload");t._resetFinishedDeferreds(),t._trigger("started",e)},stop:function(e){if(e.isDefaultPrevented())return!1;var t=$(this).data("blueimp-fileupload")||$(this).data("fileupload");$.when.apply($,t._getFinishedDeferreds()).done(function(){t._trigger("stopped",e),t.options.model.extended_progress(""),t.options.model.progress(0)})},destroy:function(e,t){if(e.isDefaultPrevented())return!1;var r=this,i=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),o=i._addFinishedDeferreds(),n=function(){i.options.model.removeFile(t.context),i._controlFileInputButton.call(r),i._trigger("destroyed",e,t),o.resolve()};t.url?(t.context.processing(!0),t.context.deleting(!0),t.dataType=t.dataType||i.options.dataType,$.ajax(t).done(n).fail(function(){i._controlFileInputButton.call(r),i._trigger("destroyfailed",e,t)})):n()}},_BitrateTimer:function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.startTime=this.timestamp,this.bitrate=0,this.getBitrate=function(e,t,r){var i=e-this.timestamp;return(!this.bitrate||!r||i>r)&&(this.bitrate=t*(1e3/(e-this.startTime)),this.timestamp=e),this.bitrate}},_create:function(){this._super(),this._resetFinishedDeferreds(),$.support.fileInput||this._disableFileInputButton()},_addUpload:function(e,t){var r=[];return e.forEach(function(e){f=this.options.model.addUploadFile(e.name,e.size,e.type),f.data=t,r.push(f)},this),r},_cancelHandler:function(e,t){e.preventDefault();var r=t.data||{};t.processing(!0),t.canceling(!0),r.abort&&"rejected"!==r.state()&&"resolved"!==r.state()?r.abort():(r.errorThrown="abort",this._trigger("fail",e,r))},_startHandler:function(e,t){e.preventDefault();var r=t.data;r.context&&r.context.forEach(function(e){e.uploading(!0)}),r&&r.submit&&r.submit()},_deleteHandler:function(e,t){e.preventDefault();t.data;this._trigger("destroy",e,{context:t,type:"DELETE",url:t.delete_url()})},_formatFileSize:function(e){return"number"!=typeof e?"":e>=1073741824?(e/1073741824).toFixed(2)+" GiB":e>=1048576?(e/1048576).toFixed(2)+" MiB":(e/1024).toFixed(2)+" KiB"},_formatBitrate:function(e){return"number"!=typeof e?"":e>=1073741824?(e/1073741824).toFixed(2)+" GiB/s":e>=1048576?(e/1048576).toFixed(2)+" MiB/s":e>=1024?(e/1024).toFixed(2)+" KiB/s":e+" B/s"},_formatTime:function(e){var t=new Date(1e3*e),r=parseInt(e/86400,10);return r=r?r+"d ":"",r+("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)},_formatPercentage:function(e){return(100*e).toFixed(2)+" %"},_renderExtendedProgress:function(e){return this._formatBitrate(e.bitrate)+" | "+this._formatTime((e.total-e.loaded)/e.bitrate)+" | "+this._formatPercentage(e.loaded/e.total)+" | "+this._formatFileSize(e.loaded)+" / "+this._formatFileSize(e.total)},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(e){return e||(e=$.Deferred()),this._finishedUploads.push(e),e},_getFinishedDeferreds:function(){return this._finishedUploads},_controlFileInputButton:function(){var e=$(this).data("blueimp-fileupload")||$(this).data("fileupload");"number"==typeof e.options.maxNumberOfFiles&&e.options.maxNumberOfFiles<=e.options.getNumberOfFiles()?e._disableFileInputButton():e._enableFileInputButton()},_enableFileInputButton:function(){this.options.model.allow_input(!0)},_disableFileInputButton:function(){this.options.model.allow_input(!1)}});
